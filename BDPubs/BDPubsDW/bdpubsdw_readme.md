# üìä BDPubsDW - Implementaci√≥n de Data Warehouse

## üéØ Descripci√≥n General

**BDPubsDW** es una implementaci√≥n completa de Data Warehouse para la **base de datos Pubs**, que presenta un dise√±o de Esquema Estrella con procesos ETL automatizados usando procedimientos almacenados. Esta implementaci√≥n reemplaza los paquetes SSIS tradicionales (.dtsx) con procedimientos ETL basados en SQL para m√°xima compatibilidad y mantenibilidad.

## üèóÔ∏è Arquitectura

### **Sistema Fuente (OLTP)**
- **Base de Datos**: `pubs` (Editoriales, Autores, T√≠tulos, Ventas)
- **M√©todo CDC**: Columnas RowVersion (TIMESTAMP) para seguimiento de cambios
- **Dominio de Negocio**: Industria editorial con seguimiento de ventas

### **Sistema Destino (Data Warehouse)**
- **Base de Datos**: `PubsDataWarehouse`
- **Esquema**: Esquema Estrella (4 Dimensiones + 1 Tabla de Hechos)
- **M√©todo ETL**: Procedimientos almacenados con √°rea de staging
- **Estrategia de Actualizaci√≥n**: Cargas incrementales usando Captura de Datos de Cambio

---

## üìà Diagrama de Flujo de Datos

```mermaid
graph LR
    A[Pubs OLTP] -->|CDC RowVersion| B[Tablas Staging]
    B -->|Transformar y Validar| C[Esquema Estrella DW]
    C -->|M√©tricas de Negocio| D[Reportes y An√°lisis]
    
    A1[sales] --> S1[StagingSales]
    A2[stores] --> S2[StagingStore]
    A3[titles] --> S3[StagingTitle]
    A4[authors] --> S4[StagingAuthor]
    
    S1 --> F1[FactSales]
    S2 --> D1[DimStore]
    S3 --> D2[DimTitle]
    S4 --> D3[DimAuthor]
    
    style A fill:#ffcccc
    style C fill:#ccffcc
    style D fill:#ccccff
```

---

## üóÑÔ∏è Dise√±o del Esquema Estrella

### **üìè Dimensiones (4 tablas)**

#### **DimStore** - Informaci√≥n de Tiendas/Librer√≠as
```sql
StoreKey (PK, Identity)     -- Llave Subrogada
stor_id_original            -- Llave de Negocio del OLTP
stor_name, stor_address     -- Atributos descriptivos
city, state, zip            -- Informaci√≥n geogr√°fica
```

#### **DimTitle** - Libros/Publicaciones (Desnormalizada)
```sql
TitleKey (PK, Identity)     -- Llave Subrogada
title_id_original           -- Llave de Negocio del OLTP
title, type, price          -- Atributos del libro
publisher_name              -- Desnormalizada de tabla publishers
publisher_city, state       -- Informaci√≥n de ubicaci√≥n editorial
```

#### **DimAuthor** - Autores con Relaciones de T√≠tulos
```sql
AuthorKey (PK, Identity)    -- Llave Subrogada
au_id_original              -- Llave de Negocio del Autor
title_id_original           -- Llave de Negocio del T√≠tulo
author_full_name            -- Calculada: Nombre + Apellido
au_ord, royaltyper         -- Datos de relaci√≥n autor-t√≠tulo
```

#### **DimDate** - Dimensi√≥n Tiempo
```sql
DateKey (PK, YYYYMMDD)      -- Fecha en formato entero
FullDate, Year, Quarter     -- Componentes de fecha
MonthName, DayName          -- Nombres descriptivos
IsWeekend, IsHoliday        -- Indicadores especiales
```

### **üìä Tabla de Hechos (1 tabla)**

#### **FactSales** - Transacciones de Ventas
```sql
SalesKey (PK, Identity)     -- Llave Subrogada
StoreKey (FK)               -- ‚Üí DimStore
TitleKey (FK)               -- ‚Üí DimTitle  
AuthorKey (FK)              -- ‚Üí DimAuthor
OrderDateKey (FK)           -- ‚Üí DimDate

-- Medidas (M√©tricas de Negocio)
Quantity                    -- Libros vendidos
UnitPrice                   -- Precio por libro
TotalAmount                 -- Calculado: Quantity * UnitPrice
DiscountPercent             -- Descuento aplicado
NetAmount                   -- Monto final despu√©s del descuento
```

---

## ‚öôÔ∏è Implementaci√≥n ETL

### **üîÑ Flujo del Proceso ETL**

```
1. Extraer    ‚Üí  2. Transformar  ‚Üí  3. Cargar     ‚Üí  4. Controlar
Obtener cambios  Limpiar datos     Fusionar DW     Actualizar config
del OLTP         en staging        tablas          seguimiento
```

### **üìù Resumen de Procedimientos ETL**

| **Procedimiento** | **Reemplaza SSIS** | **Funci√≥n** | **Dependencias** |
|-------------------|-------------------|--------------|------------------|
| `sp_ETL_DimStore` | DimStore.dtsx | ETL dimensi√≥n tiendas | Ninguna |
| `sp_ETL_DimTitle` | DimTitle.dtsx | ETL dimensi√≥n t√≠tulos | Ninguna |
| `sp_ETL_DimAuthor` | DimAuthor.dtsx | ETL dimensi√≥n autores | DimTitle |
| `sp_ETL_FactSales` | FactSales.dtsx | ETL tabla de hechos ventas | Todas las dimensiones |
| `sp_ETL_IncrementalLoad` | MasterETL.dtsx | Orquestaci√≥n ETL completa | Todos los anteriores |

---

## üìã Documentaci√≥n Detallada de Procedimientos

### **üè™ sp_ETL_DimStore**
**Prop√≥sito**: Procesar datos de dimensi√≥n tiendas/librer√≠as

**Proceso**:
1. **Extraer**: Obtener tiendas con RowVersion > √∫ltima procesada
2. **Staging**: Cargar cambios en `StagingStore` 
3. **Transformar**: Limpiar y validar datos de tiendas
4. **Cargar**: MERGE en `DimStore` (INSERT nuevos, UPDATE modificados)
5. **Controlar**: Actualizar `PackageConfig` con nuevo RowVersion

**L√≥gica de Negocio**:
- Detecta nuevas librer√≠as y cambios de direcci√≥n
- Mantiene informaci√≥n hist√≥rica de tiendas
- Maneja cierres y reaperturas de tiendas

---

### **üìö sp_ETL_DimTitle**
**Prop√≥sito**: Procesar dimensi√≥n libros/t√≠tulos con informaci√≥n editorial

**Proceso**:
1. **Extraer**: Obtener t√≠tulos + editoriales (DESNORMALIZADA) donde cambi√≥ RowVersion
2. **Staging**: Cargar en `StagingTitle` con info editorial incluida
3. **Transformar**: Combinar datos de t√≠tulo y editorial en una sola fila
4. **Cargar**: MERGE en `DimTitle` 
5. **Controlar**: Actualizar seguimiento para tablas 'titles' y 'publishers'

**L√≥gica de Negocio**:
- **Desnormalizaci√≥n**: Incluye nombre editorial, ciudad, estado en dimensi√≥n t√≠tulo
- Maneja cambios de precios y actualizaciones de metadatos de libros
- Rastrea cambios editoriales que afectan t√≠tulos

---

### **‚úçÔ∏è sp_ETL_DimAuthor**
**Prop√≥sito**: Procesar dimensi√≥n autores con relaciones de t√≠tulos

**Proceso**:
1. **Extraer**: Obtener authors + titleauthor + titles (JOIN de 3 tablas)
2. **Staging**: Cargar datos complejos de relaci√≥n en `StagingAuthor`
3. **Transformar**: Crear combinaciones autor-t√≠tulo con info de regal√≠as
4. **Cargar**: MERGE en `DimAuthor` (una fila por par autor-t√≠tulo)
5. **Controlar**: Actualizar seguimiento para tablas 'authors' y 'titleauthor'

**L√≥gica de Negocio**:
- **Una fila por relaci√≥n autor-t√≠tulo** (no por autor)
- Incluye porcentajes de regal√≠as y orden de autores
- Columna calculada: `author_full_name = Nombre + Apellido`
- Maneja casos donde autores escriben m√∫ltiples libros

---

### **üí∞ sp_ETL_FactSales**
**Prop√≥sito**: Procesar transacciones de ventas (tabla de hechos)

**Proceso**:
1. **Extraer**: Obtener ventas + precios + info de descuentos
2. **Staging**: Cargar en `StagingSales` con precios unitarios calculados
3. **Transformar**: 
   - **Lookup StoreKey** de `stor_id` ‚Üí `DimStore.StoreKey`
   - **Lookup TitleKey** de `title_id` ‚Üí `DimTitle.TitleKey`
   - **Lookup AuthorKey** de `title_id` ‚Üí `DimAuthor.AuthorKey`
   - **Lookup DateKey** de `ord_date` ‚Üí `DimDate.DateKey`
4. **Cargar**: INSERT en `FactSales` (hechos t√≠picamente solo INSERT)
5. **Controlar**: Actualizar seguimiento de 'sales'

**L√≥gica de Negocio**:
- **Lookups de Llaves Subrogadas**: Convertir llaves naturales a llaves del warehouse
- **C√°lculos de Negocio**: Monto total, c√°lculos de descuentos, monto neto
- **Manejo de Fechas**: Convertir datetime a DateKey (formato YYYYMMDD)
- **Prevenci√≥n de Duplicados**: Verificar √≥rdenes existentes antes de insertar

---

### **üéØ sp_ETL_IncrementalLoad (Orquestador Principal)**
**Prop√≥sito**: Ejecutar flujo ETL completo en secuencia correcta

**Proceso**:
1. **Log Inicio**: Imprimir hora de inicio ETL y par√°metros
2. **Dimensiones Primero**: Ejecutar todos los procedimientos de dimensi√≥n en orden seguro
   ```sql
   EXEC sp_ETL_DimStore    -- Independiente
   EXEC sp_ETL_DimTitle    -- Independiente  
   EXEC sp_ETL_DimAuthor   -- Depende de DimTitle
   ```
3. **Hechos al Final**: Ejecutar procedimiento de tabla de hechos
   ```sql
   EXEC sp_ETL_FactSales   -- Depende de TODAS las dimensiones
   ```
4. **Estad√≠sticas**: Mostrar conteos finales y m√©tricas de rendimiento
5. **Log Final**: Imprimir hora de finalizaci√≥n y duraci√≥n

**L√≥gica de Negocio**:
- **Gesti√≥n de Dependencias**: Asegura que dimensiones carguen antes que hechos
- **Manejo de Errores**: Si cualquier procedimiento falla, todo el ETL se detiene
- **Monitoreo de Rendimiento**: Rastrea tiempo de ejecuci√≥n y conteos de filas
- **Logging**: Seguimiento detallado de progreso para depuraci√≥n

---

## üîç Implementaci√≥n de Captura de Datos de Cambio (CDC)

### **üìä Seguimiento con RowVersion**

Cada tabla fuente tiene una columna `RowVersion TIMESTAMP` que se actualiza autom√°ticamente:

```sql
-- Ejemplo: tabla sales
stor_id  ord_num  title_id  qty  RowVersion
'7066'   'A2976'  'PC8888'   5   0x00000001
'7066'   'A2976'  'PC8888'   3   0x00000002  ‚Üê Cambi√≥ cantidad
```

### **üéØ Procedimientos CDC**

#### **GetStoresByChange**
```sql
@StartRowVersion = 0x00000001  -- √öltima procesada
@EndRowVersion   = 0x00000002  -- @@DBTS actual
-- Retorna: Solo tiendas modificadas entre estas versiones
```

#### **GetSalesByChange** 
```sql
-- Consulta compleja uniendo:
-- sales + titles (para precio) + discounts (para % descuento)
-- Retorna: Registro completo de ventas con campos calculados
```

#### **Tabla PackageConfig**
```sql
TableName     LastRowVersion  LastUpdated
'stores'      0x00000001      2024-12-19 10:30:00
'sales'       0x00000001      2024-12-19 10:30:00
'titles'      0x00000001      2024-12-19 10:30:00
```

---

## üõ†Ô∏è Implementaci√≥n y Uso

### **üöÄ Configuraci√≥n Inicial**
```sql
-- 1. Implementar warehouse completo
EXEC [ruta]/00-Deploy-Complete.sql

-- 2. Realizar carga inicial completa
EXEC sp_ETL_FullLoad;
```

### **üîÑ Operaciones Regulares**
```sql
-- Actualizaciones incrementales diarias/por hora
EXEC sp_ETL_IncrementalLoad;

-- Verificar estado del ETL
SELECT * FROM vw_ETLStatus;

-- Ver estad√≠sticas del warehouse  
EXEC sp_ETL_ShowStatistics;
```

### **üîß Mantenimiento**
```sql
-- Reiniciar para recarga completa
EXEC ResetETLConfig;

-- Actualizaci√≥n manual de dimensiones
EXEC sp_ETL_ProcessDimensions;
```

---

## üìÅ Estructura de Archivos

```
BDPubsDW/
‚îú‚îÄ‚îÄ üìÑ README.md                          ‚Üê Este archivo
‚îú‚îÄ‚îÄ üìÅ Scripts/                           ‚Üê Automatizaci√≥n de implementaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ 00-Deploy-Complete.sql           ‚Üê Script maestro de implementaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ 01-ModifyOLTP.sql               ‚Üê Agregar RowVersion al OLTP
‚îÇ   ‚îú‚îÄ‚îÄ 02-InitializeConfig.sql         ‚Üê Configuraci√≥n inicial del ETL
‚îÇ   ‚îî‚îÄ‚îÄ 03-PopulateDimDate.sql          ‚Üê Datos de dimensi√≥n fecha
‚îú‚îÄ‚îÄ üìÅ StoredProcedures/                 ‚Üê Implementaci√≥n ETL
‚îÇ   ‚îú‚îÄ‚îÄ ETL_MasterProcedures.sql        ‚Üê Procedimientos ETL principales
‚îÇ   ‚îú‚îÄ‚îÄ GetChangesProcedures.sql        ‚Üê Procedimientos de extracci√≥n CDC
‚îÇ   ‚îî‚îÄ‚îÄ MergeProcedures.sql             ‚Üê L√≥gica de fusi√≥n staging a DW
‚îî‚îÄ‚îÄ üìÅ Tables/                          ‚Üê Definici√≥n de esquema estrella
    ‚îú‚îÄ‚îÄ üìÅ Dimensions/                   ‚Üê Esquemas de tablas dimensi√≥n
    ‚îÇ   ‚îú‚îÄ‚îÄ DimAuthor.sql
    ‚îÇ   ‚îú‚îÄ‚îÄ DimDate.sql
    ‚îÇ   ‚îú‚îÄ‚îÄ DimStore.sql
    ‚îÇ   ‚îî‚îÄ‚îÄ DimTitle.sql
    ‚îú‚îÄ‚îÄ üìÅ Facts/                        ‚Üê Esquema de tabla de hechos
    ‚îÇ   ‚îî‚îÄ‚îÄ FactSales.sql
    ‚îî‚îÄ‚îÄ üìÅ Staging/                      ‚Üê √Årea de staging ETL
        ‚îî‚îÄ‚îÄ StagingTables.sql
```

---

## üìä Capacidades de Inteligencia de Negocios

### **üéØ An√°lisis Soportados**

1. **An√°lisis de Rendimiento de Ventas**
   - Ingresos por tienda y per√≠odo de tiempo
   - T√≠tulos y autores m√°s vendidos
   - Tendencias de ventas estacionales

2. **M√©tricas de Rendimiento de Autores**
   - An√°lisis de regal√≠as por autor
   - Rendimiento de autores con m√∫ltiples libros
   - Patrones de colaboraci√≥n entre autores

3. **Inteligencia de Operaciones de Tiendas**
   - Comparaci√≥n de rendimiento de tiendas
   - Distribuci√≥n geogr√°fica de ventas
   - Patrones de preferencias de clientes

4. **Insights de Negocio Editorial**
   - Contribuci√≥n de ingresos por editorial
   - Tasas de √©xito de t√≠tulos por editorial
   - An√°lisis de participaci√≥n en el mercado

### **üìà Consultas de Negocio de Ejemplo**

```sql
-- Tiendas con mejor rendimiento por ingresos
SELECT 
    ds.stor_name AS [Nombre Tienda],
    SUM(fs.NetAmount) AS [Ingresos Totales],
    COUNT(*) AS [Total Pedidos]
FROM FactSales fs
JOIN DimStore ds ON fs.StoreKey = ds.StoreKey
JOIN DimDate dd ON fs.OrderDateKey = dd.DateKey
WHERE dd.Year = 2024
GROUP BY ds.stor_name
ORDER BY [Ingresos Totales] DESC;

-- An√°lisis de regal√≠as de autores
SELECT 
    da.author_full_name AS [Nombre Autor],
    da.title AS [T√≠tulo],
    AVG(da.royaltyper) AS [Porcentaje Regal√≠as Promedio],
    SUM(fs.NetAmount) AS [Ventas Totales]
FROM FactSales fs
JOIN DimAuthor da ON fs.AuthorKey = da.AuthorKey
GROUP BY da.author_full_name, da.title
ORDER BY [Ventas Totales] DESC;
```

---

## üîß Especificaciones T√©cnicas

### **üèóÔ∏è Requerimientos de Infraestructura**
- **Motor de Base de Datos**: SQL Server 2017+ (soporta TIMESTAMP y MERGE)
- **Memoria**: M√≠nimo 4GB RAM para procesamiento
- **Almacenamiento**: Estimado 2-5x el tama√±o de la base de datos OLTP
- **Permisos**: db_owner en ambas bases de datos OLTP y DW

### **‚ö° Caracter√≠sticas de Rendimiento**
- **Carga Inicial**: ~5-15 minutos (depende del volumen de datos)
- **Carga Incremental**: ~30 segundos - 2 minutos
- **Volumen Soportado**: 1M+ transacciones de ventas
- **Usuarios Concurrentes**: 10-50 consultas simult√°neas

### **üîí Caracter√≠sticas de Seguridad**
- **Seguimiento a nivel de fila**: RowVersion previene p√©rdida de datos
- **Rastro de auditor√≠a**: Historial completo de cambios en staging
- **Manejo de errores**: Bloques TRY/CATCH con logging
- **Validaci√≥n de datos**: Restricciones y reglas de negocio

---

## ü§ù Comparaci√≥n con Implementaci√≥n SSIS

| **Aspecto** | **Paquetes SSIS** | **Procedimientos Almacenados** |
|------------|-------------------|--------------------------------|
| **üé® Desarrollo** | Dise√±ador visual | C√≥digo SQL |
| **üîß Mantenimiento** | Dependiente de GUI | Basado en texto, amigable con control de versiones |
| **üöÄ Implementaci√≥n** | Archivos .dtsx + cat√°logo | Solo scripts SQL |
| **üîç Depuraci√≥n** | Depuraci√≥n visual | Declaraciones PRINT + logs |
| **üìä Rendimiento** | Motor optimizado | Motor de base de datos nativo |
| **üîí Seguridad** | Autenticaci√≥n Windows/SQL | Permisos de base de datos |
| **üíæ Portabilidad** | Espec√≠fico de SQL Server | Cualquier instancia SQL Server |
| **üë• Desarrollo en Equipo** | Conflictos de fusi√≥n comunes | Colaboraci√≥n SQL est√°ndar |

**‚úÖ Ventajas del enfoque con Procedimientos Almacenados:**
- Mejor control de versiones con Git
- Revisi√≥n de c√≥digo y colaboraci√≥n m√°s f√°cil  
- Sin dependencia del runtime SSIS
- Manejo de errores m√°s transparente
- Proceso de implementaci√≥n m√°s simple

---

## üìö Recursos Adicionales

### **üìñ Referencias de Documentaci√≥n**
- [Dise√±o de Esquema Estrella de Microsoft](https://docs.microsoft.com/es-es/sql/relational-databases/tables/temporal-tables)
- [Mejores Pr√°cticas de Captura de Datos de Cambio](https://docs.microsoft.com/es-es/sql/relational-databases/track-changes/about-change-data-capture-sql-server)
- [Documentaci√≥n de Declaraci√≥n MERGE](https://docs.microsoft.com/es-es/sql/t-sql/statements/merge-transact-sql)

### **üõ†Ô∏è Herramientas para An√°lisis**
- **SQL Server Management Studio**: Acceso directo a base de datos
- **Azure Data Studio**: Interfaz moderna de consultas
- **Power BI**: Conectar directamente al DW para reportes
- **Excel**: Power Pivot puede consumir el esquema estrella

---

## üèÜ Estado de Implementaci√≥n

- ‚úÖ **Esquema Estrella Completo**: 4 dimensiones + 1 tabla de hechos
- ‚úÖ **ETL Automatizado**: Procedimientos almacenados reemplazan paquetes SSIS
- ‚úÖ **Captura de Datos de Cambio**: Actualizaciones incrementales basadas en RowVersion
- ‚úÖ **Manejo de Errores**: Bloques TRY/CATCH comprensivos
- ‚úÖ **Logging**: Seguimiento detallado de ejecuci√≥n
- ‚úÖ **Documentaci√≥n**: Documentaci√≥n t√©cnica completa
- ‚úÖ **Implementaci√≥n**: Scripts de configuraci√≥n de un clic
- ‚úÖ **Pruebas**: Validado con datos de ejemplo

**üéØ Listo para uso en producci√≥n y evaluaci√≥n acad√©mica.**

---

*Esta implementaci√≥n de Data Warehouse demuestra conceptos ETL de nivel empresarial usando capacidades nativas de SQL Server, proporcionando funcionalidad equivalente a los paquetes SSIS mientras mantiene mejor mantenibilidad y portabilidad.*